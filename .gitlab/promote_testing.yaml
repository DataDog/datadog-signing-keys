---
# promote_testing stage
# Contains jobs which deploy signing keys package to testing repsoitories that are used in kitchen tests.

# deb-s3 is not able to promote packages supporting all architectures in an empty repo:
# https://github.com/krobertson/deb-s3/blob/5e6ac2897c2b5752ecea9ffe24d2d5f5ad75805c/lib/deb/s3/cli.rb#L204-L212
# we need to first upload it to supported archs, allowing us to promote the package to the testing repository
initialize-dummy-packages:
  stage: promote_testing
  image: $INTERNAL_REGISTRY/datadog-agent-buildimages/gitlab_agent_deploy:$DATADOG_AGENT_BUILDIMAGES
  tags: ["arch:amd64"]
  rules:
    - when: always
  script: 
    - set +x
    # Rename deb files: replace "1.4.0" with "0.4.2" in filenames
    - mkdir renamed_pkg
    - |
      for deb_file in $OMNIBUS_PACKAGE_DIR/*1.4.0*.deb; do
          if [[ -f "$deb_file" ]]; then
              base_name=$(basename "$deb_file")
              new_name=$(echo "$base_name" | sed 's/[0-9]\+\.[0-9]\+\.[0-9]\+/0.4.2/g')
              cp "$deb_file" renamed_pkg/"$new_name"
          fi
      done
    - |
      for component in 6 7 main observability-pipelines-worker-1 observability-pipelines-worker-2; do
        deb-s3 upload -c "$BRANCH" -m $component -b $DEB_S3_BUCKET -a $ARCH --no-preserve_versions --visibility public --prefix "$PREFIX" renamed_pkg/datadog-signing-keys_*.deb
      done
  variables:
    PREFIX: pipeline-${CI_PIPELINE_ID}
    DEB_S3_BUCKET: apttesting.datad0g.com
    BRANCH: stable
    ARCH: amd64
  before_script:
    - source /root/.bashrc
    - ls $OMNIBUS_PACKAGE_DIR

# Release to ephemeral testing repository
trigger-package-promotion-pipeline-testing-stable:
  extends: .package-promotion-template
  stage: promote_testing
  rules:
    - when: always
  variables:
    TARGET_REPO: "testing"
    TARGET_CHANNEL: "stable"
    AUTO_RELEASE: "true"
    FOLLOW: "true"
  needs:
    - job: initialize-dummy-packages
      artifacts: false
